{% extends "index.html" %}
{% block content %}
<div class="container my-5 shadow-sm p-4 bg-white rounded">    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center bg-welcome-section rounded-3 p-2 mb-4">
        <h2 class="mb-0 text-light">Album Details</h2>
        <div class="d-flex gap-2">
            <!-- Trigger edit modal -->
            <a class="btn btn-success btn-outline-light" data-bs-toggle="modal" data-bs-target="#editAlbumModal">
                Edit Album
            </a>
            <a href="#" class="btn btn-light btn-view">Download Album</a>
            <form action="{% url 'delete_album' album.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit"
                    class="btn btn-danger flex-fill"
                    onclick="return confirm('Are you sure you want to delete this album?');">
                    Delete
                </button>
            </form>
        </div>
    </div>

    <!-- Album Card -->
    <div class="card mb-4">
        <div class="row g-0">
            <div class="col-md-4">
                {% if album.cover_photo %}
                    <img src="{{ album.cover_photo.url }}" class="img-fluid rounded-start" alt="Cover Photo">
                {% else %}
                    <img src="https://via.placeholder.com/300x200?text=No+Cover+Photo" class="img-fluid rounded-start" alt="No Cover Photo">
                {% endif %}
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <p class="card-text fs-4 fw-bold">Album Name: {{ album.name }}</p>
                    <p class="card-text fst-italic">Description: {{ album.description }}</p>
                    <p class="card-text"><small class="text-muted fw-bold">Created on: {{ album.created_at|date:"F j, Y, g:i a" }}</small></p>
                    <p class="card-text"><small class="text-muted fw-bold">Created by: {{ album.created_by.username }}</small></p>
                    <p class="card-text"><small class="text-muted fw-bold">Shared with: 
                        {% for member in album.shared_with.all %}
                            {{ member.username }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            No members
                        {% endfor %}
                    </small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Photos -->
    <div class="d-flex justify-content-between align-items-center bg-welcome-section rounded-3 p-2 mb-2">
        <h2 class="mb-0 text-light">Photos in this Album</h2>
        <button type="button" class="btn btn-success btn-outline-light" data-bs-toggle="modal" data-bs-target="#addPhotoModal">
            + Add Image in this Album
        </button>
    </div>

    <div class="row">
        {% for photo in photos %}
            <div class="col-md-3 mb-4">
                <div class="card h-100 shadow-sm">
                    <img src="{{ photo.image.url }}" class="card-img-top" alt="Photo">
                </div>
            </div>
        {% empty %}
            <p>No photos in this album.</p>
        {% endfor %}
    </div>  

    <a href="{% url 'album_list' %}" class="btn btn-secondary mt-3">Back to Albums</a>
</div>

<!-- ================== EDIT ALBUM MODAL ================== -->
<div class="modal fade" id="editAlbumModal" tabindex="-1" aria-labelledby="editAlbumLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editAlbumForm" method="post" action="{% url 'album_edit' album.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editAlbumLabel">Edit Album</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          {% if user == album.created_by or user.is_family_head %}
            <div class="mb-3">
              <label for="id_name" class="form-label">Album Name</label>
              <input type="text" name="name" id="id_name" class="form-control" value="{{ album.name }}">
            </div>
            <p>Family Members Count: {{ family_members|length }}</p>
            <div class="mb-3">
              <label class="form-label">Shared With</label>
              <div class="form-check">
                {% for member in family_members %}
                <input type="checkbox" name="shared_with" value="{{ member.id }}" id="member_{{ member.id }}" class="form-check-input"
                       {% if member in album.shared_with.all %}checked{% endif %}>
                <label for="member_{{ member.id }}" class="form-check-label">
                    {{ member.username }}
                </label><br>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <div class="alert alert-danger">
              You are not allowed to edit this album.
            </div>
          {% endif %}
        </div>

        {% if user == album.created_by or user.is_family_head %}
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<!-- ================== ADD PHOTO MODAL ================== -->
<div class="modal fade" id="addPhotoModal" tabindex="-1" aria-labelledby="addPhotoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" action="{% url 'add_photo_to_album' album.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addPhotoModalLabel">Add Photo to Album</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="photo" class="form-label">Select Image</label>
            <input type="file" name="photo" id="photo" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
