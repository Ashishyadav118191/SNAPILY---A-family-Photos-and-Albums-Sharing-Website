{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <title>
        {% block title %}
            Snapily : family photo sharing app
        {% endblock %}
    </title>

<style>
    body{
        padding-top : 60px;
    }

    .welcome-text {
    opacity: 0;
    transform: translateY(-20px);
    animation: fadeSlideIn 1s ease-out forwards;
    }

    @keyframes fadeSlideIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
    }
    .members-wrapper {
    background-color: #f8f9fa; 
    border-radius: .5rem;
    box-shadow: 0 1rem 2rem rgba(0,0,0,0.1);
    padding: 2rem;
     }
    .scroll-btn {
    border: 1px solid transparent; 
    color: var(--bs-primary);       
    }

    .scroll-btn:hover {
    border-color: #3C7289 ; 
    }
    .btn-view {
        border : 1px solid ;
        border-color : #3C7289;
    }
    .album-card {
    height: 100%; 
    display: flex;
    flex-direction: column;
    }

    .album-card img {
        height: 250px;       
        object-fit: cover;      
        object-position: top;   
        width: 100%;
    }

    .album-card .card-body {
        display: flex;
        flex-direction: column;
        flex-grow: 1; 
    }

    .album-card .btn {
        margin-top: auto; 
    }
    .row {
        flex-wrap: wrap !important;
        overflow-x: hidden !important;
    }
    .album-slider {
        scroll-snap-type: x mandatory;
    }
    .album-slider .card {
        scroll-snap-align: start;
    }
    .bg-color{
        background-color: #E3DDCF;
    }
    .bg-welcome{
        background-color: #3C7289;
        color: #ffff;
    }
    .navtext{
        color: #3C7289;
    }
    .custom-brand-color {
    color: #3C7289 !important;
    }
    .bg-welcome:hover{
        background-color: #ffffffff;
        color: #000000ff;
        border: 1px solid #3C7289;
    }
    .bg-welcome-section{
        background-color: #3C7289;
    }
    .memory-card img {
        height: 250px;       
        object-fit: cover;      
        object-position: top;   
        width: 100%;
    }
    .btn-color{
    background-color: #3C7289;
    color: #ffffff;
    }
    .btn-color:hover{
    background-color: #2c4e61;
    color: #ffffff;
}
.font-color{
    color: #3C7289;
}
</style>

</head>

<body class="bg-color text-primary">
    <nav class="navbar navbar-expand-lg navbar-light bg-color shadow-sm fixed-top">
    <div class="container navtext">
        <!-- Brand -->
        <a class="navbar-brand d-flex align-items-center">
        <i class="bi bi-camera-fill me-4 fs-4 custom-brand-color"></i>
        <span class="fw-bold custom-brand-color">SNAPILY</span>
        </a>

        <!-- Toggler -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#fbNav"  aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Nav links + Actions -->
        <div class="collapse navbar-collapse" id="fbNav">
        <ul class="navbar-nav m-left-auto mb-5 mb-lg-0 gap-3 ms-auto p-2">
            <li class="nav-item space evenly "><a class="nav-link active" href="{%url 'index'%}">Home</a></li>
            <li class="nav-item"><a class="nav-link active" href="{% url 'memory_list' %}">Memories</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'album_list' %}">Albums</a></li>
            <li class="nav-item"><a class="nav-link" href="#members">Members</a></li>
        </ul>

        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'profile_view' %}" class="btn btn-color">Profile</a>

            <!-- Add (+) button -->
                <a href="{% url 'create_album' %}" 
                class="btn btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center"
                style="width:36px;height:36px" 
                aria-label="Add">
                    <i class="bi bi-plus-lg"></i>
                </a>
        </div>
        </div>
    </div>
    </nav>
    <!--messege to confirm delete member-->
    1{% if messages %}
        <div class="container mt-3 ">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
        {% endfor %}
    </div>
    {% endif %}
    <div class="container">
             {% block content %}
            <section class="py-5 bg-welcome-section mt-3 rounded-3 text-white text-center position-relative">
            <div class="container ">
                <h1 class="display-4 welcome-text">
                    {% if user.is_family_head %}
                        Hello Head , {{ user.name|default:user.username }}
                    {% else %}
                        Hello Member , {{ user.name|default:user.username }}
                    {% endif %}
                </h1>
                <p class="lead mt-3 ">{{ user.fullname }}, welcomes you in </p>
                <p class="lead fw-bold">Snapily - Your Family Vault of Memories</p>

                {% if admin_code %}
                <div class="position-absolute top-0 end-0 p-3">
                <span class="badge bg-danger">Family Code: {{ admin_code }}</span>
                </div>
                {% endif %}
            </div>
            </section>

        <div class="container  mt-2 members-wrapper"id="members">
            <h2 class="text-center font-color mb-3">Our Members</h2>

            <div class="position-relative">
                <!-- left arrow  button for members   -->
                <button class="btn btn-light btn-lg position-absolute top-50 start-0 translate-middle-y scroll-btn" id="prevBtn">
                <i class="bi bi-chevron-left"></i>
                </button>

                <!-- scrollable member container -->
                <div class="d-flex overflow-auto" id="memberSlider" style="scroll-behavior: smooth;">
                {% for member in members %}
                <div class="card m-2 {% if member.is_family_head %}bg-light border-danger{% endif %}" style="min-width: 300px; flex: 0 0 auto;">
                    <div class="card-body text-center">
                    <h5 class="card-title {% if member.is_family_head %}text-danger{% endif %}">
                        {{ member.name|default:member.username }}
                    </h5>
                    <p class="card-text">{{ member.email }}</p>
                    {% if member.relationship_to_admin and member.is_family_member %}
                        <span class="badge bg-primary">{{ member.relationship_to_admin }}</span>
                    {% endif %}
                    {% if member.is_family_head %}
                        <span class="badge bg-primary">Head</span>
                    {% endif %}

                    <!-- Action buttons -->
                        <div class="mt-3 d-flex justify-content-center gap-3">
                        <!-- View button visible to all -->
                        <button class="btn btn-light btn-sm flex-fill btn-view" data-url="{% url 'member_details' member.username %}">
                            Details
                        </button>

                        <!-- Delete button visible only to family head -->
                        {% if request.user.is_family_head %}
                            <form action="{% url 'delete_member' member.username %}" method="post" onsubmit="return confirm('Are you sure you want to delete {{ member.fullname|default:member.username }}?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        Delete
                                    </button>
                                </form>
                        {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>

                <!-- right arrow -->
                <button class="btn btn-light btn-lg position-absolute top-50 end-0 translate-middle-y scroll-btn" id="nextBtn">
                <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            </div>
            

            <!--Model for members details-->

                <div class="modal fade" id="detailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Member Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <!-- Member details will load here -->
                    </div>
                    </div>
                </div>
                </div>

    <!--for listing all the albums-->
        <div class="container py-2 mt-2 bg-white  shadow-sm rounded-3">
            <!-- Header row in its own box -->
            <div class="d-flex justify-content-between align-items-center bg-welcome-section rounded-3 text-light mb-2 p-3">
                <h2 class="mb-0">My Albums</h2>
                <div class="d-flex gap-2">
                    <a href="{% url 'album_list' %}" class="btn btn-light btn-view">View all Albums</a>
                    <a href="{% url 'create_album' %}" class="btn btn-success btn-outline-light">+ Create New Album</a>
                </div>
            </div>

            <!-- Album grid -->

            <div class="album-slider d-flex overflow-auto gap-3 p-2">
                {% for album in albums %}
                <div class="card album-card shadow-sm" style="width: 350px; flex: 0 0 auto;">
                    {% if album.cover_photo %}
                    <img src="{{ album.cover_photo.url }}" class="card-img-top" alt="{{ album.name }}">
                    {% else %}
                    <img src="{% static 'default_cover.jpg' %}" class="card-img-top" alt="Default cover">
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ album.name }}</h5>
                    <p class="card-text">
                        <small class="text-muted">Created at: {{ album.created_at|date:"M d, Y" }}</small>
                    </p>
                    <div class="mt-auto d-flex gap-2">
                        <a href="{% url 'album_detail' album.id %}" class="btn btn-light btn-sm flex-fill btn-view">View</a>
                        <form action="{% url 'delete_album' album.id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit"
                                    class="btn btn-danger btn-sm flex-fill"
                                    onclick="return confirm('Are you sure you want to delete this album?');">
                                Delete
                            </button>
                        </form>
                    </div>
                    </div>
                </div>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <!-- list of the memories -->
        <div class="container py-2 mt-2 bg-white shadow-sm rounded-3 p-4">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center bg-welcome-section rounded-3 text-light mb-2 p-3">
                <h2 class="mb-0">My Memories</h2>
                <div class="d-flex gap-2">
                    <a href="{% url 'memory_detail' %}" class="btn btn-light btn-view">View all Memories</a>
                    <a href="{% url 'memory_list' %}" class="btn btn-success btn-outline-light">+ Create New Memory</a>
                </div>
            </div>

            <!-- Memory cards slider -->
            <div class="album-slider d-flex overflow-auto gap-3 p-2">
                {% for memory in memories %}
                <div class="card memory-card shadow-sm p-2" style="width: 350px; flex: 0 0 auto;">
                    <!-- Image -->
                    <img src="{{ memory.image.url }}" class="card-img-top" alt="{{ memory.tag }}"
                        style="height: 250px; object-fit: cover; width: 100%;">
                    
                    <!-- Card body -->
                    <div class="card-body d-flex flex-column justify-content-between">
                        <div>
                            <h5 class="card-title">{{ memory.tag }}</h5>
                            <p class="card-text mb-3">
                                <strong>Location:</strong> {{ memory.location }}<br>
                                <strong>Date:</strong> {{ memory.date }}<br>
                            </p>
                        </div>

                        <!-- Buttons of memory section -->
                        <div class="mt-auto d-flex gap-2">
                            <!-- View button larger -->
                            <a href="{% url 'memory_detail'%}" class="btn btn-light btn-sm flex-grow-1 btn-view">View</a>
                            <!-- Delete button smaller -->
                            <a href="{% url 'memory_delete' memory.id %}" class="btn btn-danger btn-sm">Delete</a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p>No memories found for this selection.</p>
                {% endfor %}
            </div>
        </div>
{% endblock %}
</div>
<!-- ================== FOOTER SECTION ================== -->
<footer class="bg-dark text-light pt-4 pb-3 mt-3">
     <div class="container py-2 mt-2 shadow-sm rounded-3 p-4">
        <div class="row align-items-start">
            <!-- Logo + Description -->
            <div class="col-md-4 mb-3">
                <h5 class="mb-2">
                <i class="bi bi-camera"></i> Family Moments And Albums 
                </h5>
                <p class="text-light mb-0">
                Preserving your family's legacy one memory at a time.
                </p>
            </div>

            <!-- Quick Links -->
            <div class="col-md-4 mb-3">
                <h6 class="fw-bold mb-2 text-uppercase">Quick Links</h6>
                <ul class="list-unstyled">
                <li><a href="#" class="text-decoration-none text-light">Create Account</a></li>
                <li><a href="#" class="text-decoration-none text-light">Sign In</a></li>
                <li><a href="#" class="text-decoration-none text-light">Privacy Policy</a></li>
                </ul>
            </div>

            <!-- Newsletter -->
            <div class="col-md-4 mb-3">
                <h6 class="fw-bold mb-2 text-uppercase">Newsletter</h6>
                <p class="text-light mb-2">Subscribe for tips on preserving family memories</p>
                <form class="d-flex">
                <input type="email" class="form-control me-2" placeholder="Your email" required>
                <button class="btn btn-primary" type="submit">Subscribe</button>
                </form>
            </div>
            </div>
            
            <hr class="border-secondary">
            
            <!-- Footer bottom -->
            <div class="text-center text-muted small">
                © 2025 Family Moments. All rights reserved.
            </div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-8Q4Qn8v1nQv4Qw8Q8Q4Qn8v1nQv4Qw8Q8Q4Qn8v1nQv4Qw8Q8Q4Qn8v1nQv4Qw8Q" crossorigin="anonymous"></script>
<script>
  const slider = document.getElementById('memberSlider');
  document.getElementById('nextBtn').onclick = () =>
    slider.scrollBy({ left: 250, behavior: 'smooth' });
  document.getElementById('prevBtn').onclick = () =>
    slider.scrollBy({ left: -250, behavior: 'smooth' });

// scripts for members views modal
document.addEventListener("DOMContentLoaded", function () {
  console.log("[debug] DOM loaded");

  const btns = document.querySelectorAll('.btn-view');
  console.log("[debug] .btn-view count:", btns.length);

  const modalEl = document.getElementById('detailsModal');
  if (!modalEl) {
    console.error("[debug] detailsModal element NOT found. Add modal HTML outside loop.");
    return;
  }
  const detailsModal = new bootstrap.Modal(modalEl);

  btns.forEach(btn => {
    btn.addEventListener('click', async function () {
      const url = this.dataset.url;
      if (!url) {
        console.error("[debug] No data-url found on button", this);
        return;
      }
      console.log("[debug] Fetching", url);

      try {
        // include credentials so session cookies (login) are sent
        const resp = await fetch(url, {
          method: 'GET',
          credentials: 'same-origin',
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        console.log("[debug] response status:", resp.status, "redirected:", resp.redirected);

        // redirect often means user is not authenticated and got redirected to login
        if (resp.redirected) {
          console.warn("[debug] fetch was redirected to", resp.url);
        }

        if (!resp.ok) {
          const text = await resp.text();
          console.error("[debug] server error:", resp.status, text.slice(0,200));
          alert("Error loading details: " + resp.status);
          return;
        }

        const html = await resp.text();

        // quick check: if server returned full login page or a full html doc,
        // you might get extra <html> tag contents; still safe to inject but check for login.
        if (html.includes('name="csrfmiddlewaretoken"') && html.toLowerCase().includes('login')) {
          console.warn("[debug] response looks like login page — user may be logged out.");
        }

        document.getElementById('modalBody').innerHTML = html;
        detailsModal.show();
        console.log("[debug] modal shown");
      } catch (err) {
        console.error("[debug] fetch error:", err);
        alert("Unexpected error: " + err.message);
      }
    });
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
